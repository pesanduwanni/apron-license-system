<ng-container *ngIf="user && application">
  <!-- Page content area (layout header comes from sectional-layout) -->
  <div class="page-body">
    <!-- Success/Error Messages -->
    <div class="alert alert-success" *ngIf="successMessage">
      ✓ {{ successMessage }}
    </div>
    <div class="alert alert-error" *ngIf="errorMessage">
      ✗ {{ errorMessage }}
    </div>

    <!-- Read-only application form mirroring applicant layout -->
    <div class="form-card">
      <!-- Back link and small reference/"New" strip like applicant view -->
      <div class="page-header">
        <button class="btn-back" (click)="goBack()">
          ← Back to List
        </button>
        <div class="header-right">
          <span class="header-ref">{{ application.referenceNumber }}</span>
          <button class="btn-new" type="button" *ngIf="isPending">New</button>
        </div>
      </div>

      <!-- Personal Information -->
      <section class="form-section">
        <header class="section-header">
          <h2>Personal Information</h2>
        </header>
        <div class="section-body">
          <div class="field-grid-2">
            <div class="field">
              <label>Name of Applicant, Staff No and Designation</label>
              <div class="field-value">
                {{ application.applicantName }} - {{ application.staffNumber }} ({{ application.designation }})
              </div>
            </div>
          </div>

          
          <div class="field-grid-3">
            <div class="field">
              <label>Section/ Department</label>
              <div class="field-value">{{ application.department }}</div>
            </div>
            <div class="field">
              <label>Contact No</label>
              <div class="field-value">{{ application.contactNumber }}</div>
            </div>
            <div class="field">
              <label>NIC No</label>
              <div class="field-value">{{ application.nic }}</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Basic Information -->
      <section class="form-section">
        <header class="section-header">
          <h2>Basic Information</h2>
        </header>
        <div class="section-body">
          <div class="field-grid-4">
            <div class="field">
              <label>License Type</label>
              <div class="field-value">
                {{ application.licenseType === 'extension' ? 'Extension License' : 'New License' }}
              </div>
            </div>
            <div class="field">
              <label>Current ADP No</label>
              <div class="field-value">{{ application.currentAdpNo || '—' }}</div>
            </div>
            <div class="field">
              <label>Date of First Issue</label>
              <div class="field-value">
                {{ application.dateOfFirstIssue ? formatDate(application.dateOfFirstIssue) : '—' }}
              </div>
            </div>
            <div class="field">
              <label>AASL Access P/No</label>
              <div class="field-value">{{ application.aaslAccessNo }}</div>
            </div>
          </div>

          <div class="field-grid-3">
            <div class="field">
              <label>Date Participation of Safety Orientation</label>
              <div class="field-value">—</div>
            </div>
            <div class="field">
              <label>AASL Access Permit Expiry Date</label>
              <div class="field-value">{{ formatDate(application.aaslAccessExpiry) }}</div>
            </div>
            <div class="field">
              <label>Requested Date</label>
              <div class="field-value">{{ formatDate(application.submittedDate) }}</div>
            </div>
          </div>
        </div>
      </section>

      <!-- License Information -->
      <section class="form-section">
        <header class="section-header">
          <h2>License Information</h2>
        </header>
        <div class="section-body">
          <div class="field-grid-4">
            <div class="field">
              <label>Civil License No. (RMV)</label>
              <div class="field-value">{{ application.stateLicenseNo }}</div>
            </div>
            <div class="field">
              <label>Category</label>
              <div class="field-value">—</div>
            </div>
            <div class="field">
              <label>Date of Issue</label>
              <div class="field-value">{{ formatDate(application.stateLicenseIssueDate) }}</div>
            </div>
            <div class="field">
              <label>Date of Expiry</label>
              <div class="field-value">{{ formatDate(application.stateLicenseExpiryDate) }}</div>
            </div>
          </div>

          <div class="field full">
            <div class="equipment-header">
              <label>Select manager recommendation for equipment type / vehicle</label>
              <button
                class="btn btn-secondary equipment-edit-btn"
                type="button"
                *ngIf="isPending"
                (click)="openEquipmentEdit()"
              >
                Edit
              </button>
            </div>
            <div class="equipment-grid">
              <label
                *ngFor="let cat of vehicleCategories"
                class="equipment-checkbox"
                [class.disabled]="true"
              >
                <input
                  type="checkbox"
                  [checked]="isCategorySelected(cat.key)"
                  [disabled]="true"
                />
                <span class="equipment-checkbox-custom"></span>
                <span>{{ cat.label }}</span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <!-- Attachments and Signature -->
      <section class="form-section">
        <header class="section-header">
          <h2>Attachments</h2>
        </header>
        <div class="section-body">
          <div class="attachment-row">
            <div class="attachment-group">
              <p class="attachment-title">Staff ID</p>
              <div class="attachment-boxes">
                <div class="attachment-box">
                  <div class="attachment-image-box">
                    <img
                      *ngIf="application.attachments.staffIdFront?.url && !failedAttachments['staffIdFront']"
                      [src]="application.attachments.staffIdFront!.url"
                      alt="Staff ID - Front"
                      (error)="imageError('staffIdFront')"
                      (load)="imageLoaded('staffIdFront')"
                    />
                    <div *ngIf="!application.attachments.staffIdFront?.url || failedAttachments['staffIdFront']" class="attachment-placeholder">Staff ID - Front</div>
                  </div>
                </div>
                <div class="attachment-box">
                  <div class="attachment-image-box">
                    <img
                      *ngIf="application.attachments.staffIdBack?.url && !failedAttachments['staffIdBack']"
                      [src]="application.attachments.staffIdBack!.url"
                      alt="Staff ID - Back"
                      (error)="imageError('staffIdBack')"
                      (load)="imageLoaded('staffIdBack')"
                    />
                    <div *ngIf="!application.attachments.staffIdBack?.url || failedAttachments['staffIdBack']" class="attachment-placeholder">Staff ID - Back</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="attachment-group">
              <p class="attachment-title">State License</p>
              <div class="attachment-boxes">
                <div class="attachment-box">
                  <div class="attachment-image-box">
                    <img
                      *ngIf="application.attachments.stateLicenseFront?.url && !failedAttachments['stateLicenseFront']"
                      [src]="application.attachments.stateLicenseFront!.url"
                      alt="State License - Front"
                      (error)="imageError('stateLicenseFront')"
                      (load)="imageLoaded('stateLicenseFront')"
                    />
                    <div *ngIf="!application.attachments.stateLicenseFront?.url || failedAttachments['stateLicenseFront']" class="attachment-placeholder">State License - Front</div>
                  </div>
                </div>
                <div class="attachment-box">
                  <div class="attachment-image-box">
                    <img
                      *ngIf="application.attachments.stateLicenseBack?.url && !failedAttachments['stateLicenseBack']"
                      [src]="application.attachments.stateLicenseBack!.url"
                      alt="State License - Back"
                      (error)="imageError('stateLicenseBack')"
                      (load)="imageLoaded('stateLicenseBack')"
                    />
                    <div *ngIf="!application.attachments.stateLicenseBack?.url || failedAttachments['stateLicenseBack']" class="attachment-placeholder">State License - Back</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="attachment-row">

            <div class="attachment-group">
              <p class="attachment-title">Aviation Pass</p>
              <div class="attachment-boxes">
                <div class="attachment-box">
                    <div class="attachment-image-box">
                      <img
                        *ngIf="application.attachments.aviationPassFront?.url && !failedAttachments['aviationPassFront']"
                        [src]="application.attachments.aviationPassFront!.url"
                        alt="Aviation Pass - Front"
                        (error)="imageError('aviationPassFront')"
                        (load)="imageLoaded('aviationPassFront')"
                      />
                      <div *ngIf="!application.attachments.aviationPassFront?.url || failedAttachments['aviationPassFront']" class="attachment-placeholder">Aviation Pass - Front</div>
                    </div>
                </div>
                <div class="attachment-box">
                    <div class="attachment-image-box">
                      <img
                        *ngIf="application.attachments.aviationPassBack?.url && !failedAttachments['aviationPassBack']"
                        [src]="application.attachments.aviationPassBack!.url"
                        alt="Aviation Pass - Back"
                        (error)="imageError('aviationPassBack')"
                        (load)="imageLoaded('aviationPassBack')"
                      />
                      <div *ngIf="!application.attachments.aviationPassBack?.url || failedAttachments['aviationPassBack']" class="attachment-placeholder">Aviation Pass - Back</div>
                    </div>
                </div>
              </div>
            </div>

            <div class="attachment-group">
              <p class="attachment-title">NIC</p>
              <div class="attachment-boxes">
                <div class="attachment-box">
                  <div class="attachment-image-box">
                            <img
                              *ngIf="application.attachments.nicFront?.url && !failedAttachments['nicFront']"
                              [src]="application.attachments.nicFront!.url"
                              alt="NIC - Front"
                              (error)="imageError('nicFront')"
                              (load)="imageLoaded('nicFront')"
                            />
                            <div *ngIf="!application.attachments.nicFront?.url || failedAttachments['nicFront']" class="attachment-placeholder">NIC - Front</div>
                  </div>
                </div>
                <div class="attachment-box">
                  <div class="attachment-image-box">
                            <img
                              *ngIf="application.attachments.nicBack?.url && !failedAttachments['nicBack']"
                              [src]="application.attachments.nicBack!.url"
                              alt="NIC - Back"
                              (error)="imageError('nicBack')"
                              (load)="imageLoaded('nicBack')"
                            />
                            <div *ngIf="!application.attachments.nicBack?.url || failedAttachments['nicBack']" class="attachment-placeholder">NIC - Back</div>
                  </div>
                </div>
              </div>
            </div>

            

          </div>

          <div class="attachment-row signature-row">
            <div class="attachment-group signature-group">
              <div class="attachment-boxes">
                <div class="attachment-box">
                  <div class="signature-image-box">
                    <img
                      *ngIf="application.attachments.signature?.url && !failedAttachments['signature']"
                      [src]="application.attachments.signature?.url || ''"
                      alt="Signature"
                      class="signature-image"
                      (error)="imageError('signature')"
                      (load)="imageLoaded('signature')"
                    />
                    <div *ngIf="!application.attachments.signature?.url || failedAttachments['signature']" class="signature-placeholder"></div>
                  </div>
                </div>
              </div>
              <p class="attachment-title signature-title">Signature</p>
            </div>
          </div>

          <div class="remarks-section">
            <label for="remarks">Add your comment here</label>
            <textarea
              id="remarks"
              [(ngModel)]="remarks"
              rows="3"
              [readonly]="!isPending"
            ></textarea>
          </div>

          <div class="action-buttons" *ngIf="isPending">
            <div class="action-left">
              <button class="btn btn-secondary" (click)="goBack()">Back</button>
            </div>
            <div class="action-right">
              <button class="btn btn-reject" (click)="openRejectModal()">Rejected</button>
              <button class="btn btn-approve" (click)="openApproveConfirm()">Accepted</button>
            </div>
          </div>

        </div>
      </section>

      <!-- Approval info (if already processed) -->
      <section class="form-section" *ngIf="!isPending">
        <header class="section-header">
          <h2>Approval Information</h2>
        </header>
        <div class="section-body">
          <div class="field-grid-3">
            <div class="field">
              <label>Processed By</label>
              <div class="field-value">{{ application.sectionalManagerName || '—' }}</div>
            </div>
            <div class="field">
              <label>Processing Date</label>
              <div class="field-value">{{ formatDate(application.sectionalApprovalDate) }}</div>
            </div>
            <div class="field full" *ngIf="application.sectionalRemarks">
              <label>Remarks</label>
              <div class="field-value">{{ application.sectionalRemarks }}</div>
            </div>
          </div>
        </div>
      </section>
    </div>

  </div>

  <!-- Footer -->
  <footer class="page-footer">
    <div class="footer-inner">
      <div class="footer-copy">
        Ⓒ  2025 SriLankan IT Systems. All rights reserved
      </div>
    </div>
  </footer>

  <!-- Confirm Modal -->
  <div class="modal-overlay" *ngIf="showConfirmModal" (click)="closeModals()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Confirm Approval</h3>
      <p>
        Are you sure you want to approve this application?
        The applicant and Safety Manager will be notified via email.
      </p>
      <div class="modal-actions">
        <button class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button class="btn btn-approve" (click)="confirmApprove()">Yes, Approve</button>
      </div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div class="modal-overlay" *ngIf="showRejectModal" (click)="closeModals()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Reject Application</h3>
      <p>Please provide a reason for rejecting this application:</p>
      <textarea
        [(ngModel)]="rejectReason"
        placeholder="Enter rejection reason..."
        rows="4"
        class="reject-textarea"
      ></textarea>
      <div class="modal-actions">
        <button class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button
          class="btn btn-reject"
          [disabled]="!rejectReason.trim()"
          (click)="confirmReject()"
        >
          Reject Application
        </button>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal-overlay preview-overlay" *ngIf="showPreviewModal" (click)="closePreview()">
    <div class="preview-modal" (click)="$event.stopPropagation()">
      <div class="preview-header">
        <h3>{{ previewTitle }}</h3>
        <button class="btn-close" (click)="closePreview()">✕</button>
      </div>
      <div class="preview-body">
        <img [src]="previewUrl" [alt]="previewTitle" />
      </div>
    </div>
  </div>

  <!-- Equipment Edit Modal -->
  <div class="modal-overlay" *ngIf="showEquipmentEditModal" (click)="closeEquipmentEdit()">
    <div class="modal equipment-modal" (click)="$event.stopPropagation()">
      <div class="modal-header equipment-header-bar">
        <div class="modal-title">Request Information</div>
        <button class="modal-close" (click)="closeEquipmentEdit()">✕</button>
      </div>

      <div class="modal-content">
        <p class="modal-subtitle">Select manager recommendation for equipment type / vehicle</p>

        <div class="equipment-grid">
          <label
            *ngFor="let cat of vehicleCategories"
            class="equipment-checkbox"
          >
            <input
              type="checkbox"
              [checked]="isCategorySelected(cat.key)"
              (change)="toggleCategory(cat.key)"
            />
            <span class="equipment-checkbox-custom"></span>
            <span>{{ cat.label }}</span>
          </label>
        </div>

        <div class="remarks-section">
          <label for="remarksEdit">Remark</label>
          <textarea
            id="remarksEdit"
            [(ngModel)]="remarks"
            rows="3"
            placeholder="Add your comment here"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button class="btn btn-approve" (click)="saveEquipmentEdit()">Update</button>
        </div>
      </div>
    </div>
  </div>
</ng-container>
